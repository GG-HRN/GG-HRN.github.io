<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Subcategories</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Subcategories">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="theme-color" content="#1e293b">
<link rel="icon" href="icons/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="icons/favicon-16x16.png" sizes="16x16">

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{background:#0f1724;color:#fff;font-family:sans-serif;margin:0}
header{background:#0b1220;color:#fff;padding:12px;display:flex;align-items:center}
#backBtn{margin-right:10px}
.card{background:#1e293b;color:#fff}
.swal2-popup{font-size:14px !important}
.muted{color:#94a3b8}
</style>
</head>
<body>
<header>
  <button id="backBtn" class="btn btn-sm btn-primary">‚Üê Back</button>
  <h5 class="m-0 w-100 text-center">Subcategories</h5>
</header>

<main class="container py-3">
  <form id="subcatForm" class="mb-3 d-flex gap-2" autocomplete="off">
    <select id="categorySelect" class="form-select">
      <option value="" disabled selected>Choose a category</option>
    </select>
    <input type="text" id="subcatInput" class="form-control" placeholder="Enter subcategory name"/>
    <button type="submit" class="btn btn-success">Add</button>
  </form>

  <input type="text" id="subcatSearch" class="form-control mb-3" placeholder="Search subcategories...">

  <div id="subcatList" class="mb-2"></div>
  <div class="d-flex flex-wrap gap-2 mt-3" id="pagination"></div>
</main>

<script>
const DB_NAME = 'StoresDB';
const DB_VERSION = 2;
let db;

// ----- IndexedDB helpers -----
function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const _db = e.target.result;
      if(!_db.objectStoreNames.contains('stores')){
        _db.createObjectStore('stores', { keyPath: 'name' });
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e.target.error);
  });
}

async function idbGet(store, key){
  if(!db) await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => res(req.result || null);
    req.onerror = () => rej(req.error);
  });
}

async function idbPut(store, value){
  if(!db) await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).put(value);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

// ----- UI elements -----
const storeName = localStorage.getItem('activeStore');
const subcatForm = document.getElementById('subcatForm');
const categorySelect = document.getElementById('categorySelect');
const subcatInput = document.getElementById('subcatInput');
const subcatSearch = document.getElementById('subcatSearch');
const subcatList = document.getElementById('subcatList');
const paginationDiv = document.getElementById('pagination');
const backBtn = document.getElementById('backBtn');
backBtn.addEventListener('click', ()=> window.location.href = 'dashboard.html');

let currentStore = null;
let filteredSubcats = [];
let currentPage = 1;
const pageSize = 6;

// ----- Load store and initialize -----
async function loadStore(){
  await openDB();
  if(!storeName){
    Swal.fire({ icon:'error', title:'No store', text:'No active store selected' });
    return;
  }
  const s = await idbGet('stores', storeName);
  if(!s){
    currentStore = { name: storeName, categories: [], subcategories: [] };
    await idbPut('stores', currentStore);
  } else {
    currentStore = s;
  }
  if(!Array.isArray(currentStore.categories)) currentStore.categories = [];
  if(!Array.isArray(currentStore.subcategories)) currentStore.subcategories = [];
  populateCategorySelect();
  applyFilters();
}

function populateCategorySelect(){
  categorySelect.innerHTML = '<option value="" disabled selected>Choose a category</option>';
  currentStore.categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    categorySelect.appendChild(opt);
  });
}

// ----- Filtering / Rendering -----
function applyFilters(){
  const q = (subcatSearch.value || '').trim().toLowerCase();
  filteredSubcats = (currentStore.subcategories || []).filter(s => 
    (s.name || '').toLowerCase().includes(q)
  );
  filteredSubcats.sort((a,b)=> a.name.toLowerCase() < b.name.toLowerCase() ? -1 : a.name.toLowerCase() > b.name.toLowerCase() ? 1 : 0);
  currentPage = 1;
  renderSubcategories();
}

function renderSubcategories(){
  subcatList.innerHTML = '';
  if(!filteredSubcats || filteredSubcats.length === 0){
    subcatList.innerHTML = '<p class="muted">No subcategories found.</p>';
    paginationDiv.innerHTML = '';
    return;
  }

  const start = (currentPage - 1) * pageSize;
  const pageSubcats = filteredSubcats.slice(start, start + pageSize);

  pageSubcats.forEach(obj => {
    const idx = currentStore.subcategories.indexOf(obj);
    const card = document.createElement('div');
    card.className = 'card mb-2 p-3 d-flex flex-row justify-content-between align-items-center';
    card.innerHTML = `
      <div><strong>${escapeHtml(obj.name)}</strong> <span class="muted">(${escapeHtml(obj.category)})</span></div>
      <div>
        <button class="btn btn-warning btn-sm me-1" data-action="edit">Edit</button>
        <button class="btn btn-danger btn-sm" data-action="delete">Delete</button>
      </div>
    `;
    card.querySelector('[data-action="edit"]').addEventListener('click', ()=> editSubcategory(idx) );
    card.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteSubcategory(idx) );
    subcatList.appendChild(card);
  });

  renderPagination();
}

function renderPagination(){
  paginationDiv.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(filteredSubcats.length / pageSize));
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm ' + (i === currentPage ? 'btn-success' : 'btn-primary');
    btn.textContent = i;
    btn.addEventListener('click', ()=> { currentPage = i; renderSubcategories(); });
    paginationDiv.appendChild(btn);
  }
}

// ----- Helpers -----
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

function normalizeName(n){ return (n||'').trim(); }
function existsSubcatCaseInsensitive(name, category, exceptIndex = -1){
  const n = name.toLowerCase();
  const c = category.toLowerCase();
  return currentStore.subcategories.some((s,i)=> i!==exceptIndex && s.name.toLowerCase() === n && s.category.toLowerCase() === c);
}

// ----- Events -----
subcatSearch.addEventListener('input', ()=> { currentPage = 1; applyFilters(); });

subcatForm.addEventListener('submit', async e => {
  e.preventDefault();
  const category = categorySelect.value;
  const name = normalizeName(subcatInput.value);
  if(!category){
    Swal.fire({ icon:'warning', title:'Select category', text:'Please choose a category first' });
    return;
  }
  if(!name){
    Swal.fire({ icon:'warning', title:'Empty', text:'Subcategory name required' });
    return;
  }
  if(existsSubcatCaseInsensitive(name, category)){
    Swal.fire({ icon:'warning', title:'Duplicate', text:'This subcategory already exists in this category' });
    return;
  }
  currentStore.subcategories.push({ name, category });
  await idbPut('stores', currentStore);
  subcatInput.value = '';
  await Swal.fire({ icon:'success', title:'Added', timer:900, showConfirmButton:false });
  applyFilters();
});

// ----- Edit / Delete -----
async function editSubcategory(index){
  if(index < 0 || index >= currentStore.subcategories.length) return;
  const obj = currentStore.subcategories[index];
  const result = await Swal.fire({
    title: 'Edit subcategory',
    input: 'text',
    inputValue: obj.name,
    showCancelButton: true,
    confirmButtonText: 'Save',
    inputValidator: v => (!v || !v.trim()) ? 'Subcategory name required' : null
  });
  if(!result || result.isDismissed) return;
  const newName = normalizeName(result.value);
  if(existsSubcatCaseInsensitive(newName, obj.category, index)){
    Swal.fire({ icon:'error', title:'Duplicate', text:'This subcategory already exists in this category' });
    return;
  }
  obj.name = newName;
  await idbPut('stores', currentStore);
  await Swal.fire({ icon:'success', title:'Saved', timer:700, showConfirmButton:false });
  applyFilters();
}

async function deleteSubcategory(index){
  if(index < 0 || index >= currentStore.subcategories.length) return;
  const obj = currentStore.subcategories[index];
  const res = await Swal.fire({
    title: 'Delete subcategory?',
    html: `Delete <strong>${escapeHtml(obj.name)}</strong> under <strong>${escapeHtml(obj.category)}</strong>?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, delete',
    confirmButtonColor: '#d33'
  });
  if(!res || !res.isConfirmed) return;
  currentStore.subcategories.splice(index, 1);
  await idbPut('stores', currentStore);
  await Swal.fire({ icon:'success', title:'Deleted', timer:700, showConfirmButton:false });
  applyFilters();
}

// ----- Init -----
loadStore();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(()=>{/*sw may fail*/});
  });
}
</script>
</body>
</html>
