<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Store Manager</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">

<!-- iOS support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Store Manager">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

<meta name="theme-color" content="#1e293b">
<link rel="icon" href="icons/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="icons/favicon-16x16.png" sizes="16x16">

<!-- Framework7 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.css" />

<style>
body {
  margin:0;
  background:#0f1724;
  color:#fff;
  font-family:-apple-system,system-ui,Arial,sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px;
}

h1 {
  text-align:center;
  margin-bottom:24px;
  font-size:1.8rem;
  color:#f8fafc;
}

#cards {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
  width:100%;
  max-width:900px;
  margin-bottom:24px;
}

.card {
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  background:#1e293b;
  padding:20px;
  border-radius:16px;
  cursor:pointer;
  transition:0.25s;
  box-shadow:0 4px 6px rgba(0,0,0,0.2);
}

.card:hover {
  background:#374151;
  transform:translateY(-2px);
  box-shadow:0 6px 10px rgba(0,0,0,0.3);
}

.card-icon {
  font-size:32px;
}

.card h2 {
  margin:0;
  font-size:16px;
  text-align:center;
  word-break:break-word;
}

.card p {
  font-size:13px;
  color:#cbd5e1;
  text-align:center;
}

.new-row {
  display:flex;
  flex-direction:column;
  width:100%;
  max-width:420px;
  gap:10px;
  margin-bottom:16px;
}

.new-row input {
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:16px;
  width:100%;
  background:#1e293b;
  color:#fff;
}

.new-row input::placeholder {
  color:#94a3b8;
}

.new-row button {
  padding:12px;
  border-radius:10px;
  border:none;
  background:#6366f1;
  color:#fff;
  font-weight:700;
  font-size:16px;
  width:100%;
  cursor:pointer;
  transition:0.2s;
}

.new-row button:hover {
  background:#4f46e5;
}

@media(min-width:600px){
  .new-row{flex-direction:row}
  .new-row button{width:auto;margin-top:0}
}
</style>
</head>
<body>

<h1>üè¨ My Stores</h1>

<div id="cards"></div>

<div class="new-row">
  <input id="storeName" placeholder="Store name">
  <input id="storeDesc" placeholder="Description">
  <button id="createBtn">Create</button>
</div>

<!-- Framework7 JS -->
<script src="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.js"></script>

<script>
const DB_NAME = 'StoresDB';
const DB_VERSION = 2; // keep the same version you already use
let dbPromise;

function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('stores')) 
        db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess=e=>resolve(e.target.result);
    req.onerror=e=>reject(e.target.error);
  });
  return dbPromise;
}

async function idbGetAll(store){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).getAll();
    req.onsuccess=()=>res(req.result || []);
    req.onerror=()=>rej(req.error);
  });
}

async function idbGet(store,key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

async function idbPut(store,value){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    const req=tx.objectStore(store).put(value);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

const app = new Framework7();

const cardsDiv = document.getElementById('cards');
const nameInput = document.getElementById('storeName');
const descInput = document.getElementById('storeDesc');
document.getElementById('createBtn').addEventListener('click', createStore);

async function loadCards(){
  cardsDiv.innerHTML='';
  const stores = await idbGetAll('stores');
  stores.forEach(s=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <div class="card-icon">üè™</div>
      <h2>${s.name}</h2>
      <p>${s.description || 'No description'}</p>
    `;
    div.onclick=()=>openStore(s.name);
    cardsDiv.appendChild(div);
  });
}

async function createStore(){
  const name = nameInput.value.trim();
  const desc = descInput.value.trim();
  if(!name) return app.dialog.alert('Enter a store name');

  const existing = await idbGet('stores', name);
  if(existing){
    app.dialog.alert('Store already exists');
    return;
  }

  const storeData = {
    name,
    description: desc,
    products: [],
    components: [],
    categories: [],
    subcategories: [],
    brands: [],
    sales: [],
    salesSummary: [],
    customers: [
      { id: 'anon', name: 'Anonymous' }
    ],
    wallet: {
      balance: 0,
      transactions: []
    }
  };

  await idbPut('stores', storeData);

  nameInput.value = '';
  descInput.value = '';
  loadCards();
}

function openStore(name){
  localStorage.setItem('activeStore', name);
  window.location.href = 'dashboard.html';
}

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js',{scope:'./'}).then(()=>console.log('SW registered')).catch(e=>console.warn('SW failed',e));
}

loadCards();
</script>

</body>
</html>
