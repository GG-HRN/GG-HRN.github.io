<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard</title>

<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Store Manager">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

<meta name="theme-color" content="#1e293b">
<link rel="icon" href="icons/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="icons/favicon-16x16.png" sizes="16x16">

<style>
body{margin:0;font-family:system-ui,Arial;background:#0f1724;color:#fff;display:flex;flex-direction:column;min-height:100vh}
header{background:#1e293b;padding:15px;text-align:center;font-size:18px;font-weight:bold}
main{flex:1;padding:20px}
.advice{background:#374151;padding:12px;border-radius:8px;margin-bottom:10px}
.advice strong{color:#f87171}
.section{margin-bottom:20px}
.section h2{margin:0 0 10px;font-size:18px}
</style>
</head>
<body>
<header id="storeTitle">Dashboard</header>
<main>
  <div id="advisories"></div>

  <div class="section">
    <h2>Quick Links</h2>
    <ul>
      <li><a href="products.html">Products</a></li>
      <li><a href="categories.html">Categories</a></li>
      <li><a href="brands.html">Brands</a></li>
      <li><a href="subcategories.html">Subcategories</a></li>
      <li><a href="components.html">Components</a></li>
      <li><a href="sales.html">Sales</a></li>
      <li><a href="production.html">Production</a></li>
    </ul>
  </div>
</main>

<script>
/* IndexedDB helpers (same as index.html) */
const DB_NAME = 'StoresDB';
const DB_VERSION = 1;
let dbPromise;

function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('stores')) db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess=e=>resolve(e.target.result);
    req.onerror=e=>reject(e.target.error);
  });
  return dbPromise;
}

async function idbGet(store,key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

/* --- Dashboard logic --- */
const storeName = localStorage.getItem('activeStore');
const storeTitle = document.getElementById('storeTitle');
const advisoriesDiv = document.getElementById('advisories');

if(!storeName){
  storeTitle.textContent = "No store selected";
}else{
  storeTitle.textContent = "ðŸ“Š Dashboard - " + storeName;
  loadDashboard();
}

async function loadDashboard(){
  const store = await idbGet('stores', storeName);
  if(!store){
    advisoriesDiv.innerHTML = `<div class="advice"><strong>Error:</strong> Store not found.</div>`;
    return;
  }

  let advices = [];

  // Advisories for products
  if(store.products.length === 0){
    advices.push("No products created yet.");
  } else {
    const lowStock = store.products.filter(p=> (p.stock||0) <= 2);
    if(lowStock.length > 0) advices.push(`${lowStock.length} product(s) low on stock.`);
  }

  // Advisories for categories/brands/subcategories
  if(store.categories.length === 0){
    advices.push("No categories defined yet.");
  }
  if(store.brands.length === 0){
    advices.push("No brands defined yet.");
  }
  if(store.subcategories.length === 0){
    advices.push("No subcategories defined yet.");
  }

  // Show advisories
  advisoriesDiv.innerHTML = advices.map(a=>`
    <div class="advice"><strong>Notice:</strong> ${a}</div>
  `).join('');
}
</script>
</body>
</html>
