<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Store Dashboard</title>

<!-- PWA basics -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Store Dashboard">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="theme-color" content="#1e293b">
<link rel="icon" href="icons/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="icons/favicon-16x16.png" sizes="16x16">

<style>
  body{margin:0;font-family:sans-serif;background:#0f1724;color:#fff;}
  header{
    display:flex;align-items:center;gap:12px;
    padding:12px 16px;background:#0b1220;color:#fff;
    position:sticky;top:0;z-index:20;
  }
  #menuBtn{
    background:#6366f1;border:0;color:#fff;
    padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;
  }
  #headerTitle{flex:1;text-align:center;font-size:16px;font-weight:700}

  /* Sidebar */
  #sidebar{
    position:fixed;top:0;left:-260px;width:260px;height:100vh;background:#111827;
    transition:left .3s ease;z-index:30;padding-top:64px;box-sizing:border-box;
  }
  #sidebar.active{left:0}
  #sidebar ul{list-style:none;padding:0;margin:0}
  #sidebar ul li{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.1);cursor:pointer}
  #sidebar ul li:hover{background:#1e293b}

  /* Overlay */
  #overlay{
    display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:25;
  }
  #overlay.active{display:block}

  /* Advisories */
  .advice{background:#1e293b;padding:12px;border-radius:8px;margin-bottom:10px}
  .advice strong{color:#f87171}
</style>
</head>
<body>
  <header>
    <button id="menuBtn">☰</button>
    <div id="headerTitle">Store Dashboard</div>
  </header>

  <div id="sidebar">
    <ul>
      <li data-nav="products.html">Products</li>
      <li data-nav="categories.html">Categories</li>
      <li data-nav="brands.html">Brands</li>
      <li data-nav="subcategories.html">Subcategories</li>
      <li data-nav="components.html">Components</li>
      <li data-nav="sales.html">Sales</li>
      <li data-nav="production.html">Production</li>
      <li data-nav="index.html">← Back to Stores</li>
    </ul>
  </div>

  <div id="overlay"></div>

  <main style="padding:16px">
    <h2 id="dashTitle">Dashboard</h2>
    <div id="advisories"></div>
  </main>

<script>
/* ---- IndexedDB helpers ---- */
const DB_NAME='StoresDB',DB_VERSION=1;let dbPromise;
function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise=new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('stores'))
        db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess=e=>res(e.target.result);
    req.onerror=e=>rej(e.target.error);
  });
  return dbPromise;
}
async function idbGet(store,key){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

/* ---- Sidebar ---- */
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const menuBtn=document.getElementById("menuBtn");

function openSidebar(){
  sidebar.classList.add("active");
  overlay.classList.add("active");
  menuBtn.style.display="none";
}
function closeSidebar(){
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
  menuBtn.style.display="";
}
menuBtn.addEventListener("click",openSidebar);
overlay.addEventListener("click",closeSidebar);
document.addEventListener("keydown",e=>{
  if(e.key==="Escape") closeSidebar();
});
sidebar.querySelectorAll("li[data-nav]").forEach(li=>{
  li.addEventListener("click",()=>{
    closeSidebar();
    setTimeout(()=>{ window.location.href=li.getAttribute("data-nav"); },200);
  });
});

/* ---- Dashboard Logic ---- */
const storeName=localStorage.getItem('activeStore');
const dashTitle=document.getElementById('dashTitle');
const advisoriesDiv=document.getElementById('advisories');

if(!storeName){
  dashTitle.textContent="No store selected";
}else{
  dashTitle.textContent=`Dashboard - ${storeName}`;
  loadDashboard();
}

async function loadDashboard(){
  const store=await idbGet('stores',storeName);
  if(!store){
    advisoriesDiv.innerHTML=`<div class="advice"><strong>Error:</strong> Store not found.</div>`;
    return;
  }

  let advices=[];

  if(store.products.length===0)
    advices.push("No products created yet.");
  else {
    const lowStock=store.products.filter(p=>(p.stock||0)<=2);
    if(lowStock.length>0)
      advices.push(`${lowStock.length} product(s) low on stock.`);
  }

  if(store.categories.length===0) advices.push("No categories defined yet.");
  if(store.brands.length===0) advices.push("No brands defined yet.");
  if(store.subcategories.length===0) advices.push("No subcategories defined yet.");

  advisoriesDiv.innerHTML = advices.length>0
    ? advices.map(a=>`<div class="advice"><strong>Notice:</strong> ${a}</div>`).join('')
    : `<div class="advice">All good! No issues detected.</div>`;
}
</script>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.log('SW registration failed', err));
  });
}

// Example: send JSON data to SW to cache dynamically
function cacheJSON(url, data){
  if(navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({
      type:'CACHE_JSON',
      url,
      data
    });
  }
}
</script>
</body>
</html>
