<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Store Dashboard</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">

<!-- iOS support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Store Dashboard">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

<!-- theme color -->
<meta name="theme-color" content="#1e293b">

<!-- favicons -->
<link rel="icon" href="icons/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="icons/favicon-16x16.png" sizes="16x16">

<style>
body{margin:0;font-family:system-ui,Arial;background:#0f1724;color:#fff;display:flex;overflow-x:hidden;}
header{background:#1e293b;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;}
header h1{margin:0;font-size:18px}
#sidebar{position:fixed;top:0;left:-250px;width:250px;height:100%;background:#111827;transition:0.3s;padding-top:60px;z-index:1000;}
#sidebar ul{list-style:none;padding:0;margin:0;}
#sidebar ul li{padding:16px;color:#fff;cursor:pointer;transition:0.2s;}
#sidebar ul li:hover{background:#374151;}
#sidebarOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;z-index:900;}
#sidebarToggle{background:#6366f1;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer;}
#main{flex:1;padding:16px;margin-left:0;transition:margin-left 0.3s;}
section{display:none;}
section.active{display:block;}
.product-card{background:#1e293b;padding:12px;border-radius:12px;margin-bottom:12px;}
.product-card h3{margin:0 0 4px 0;font-size:16px;}
.product-card p{font-size:12px;color:#cbd5e1;}
</style>
</head>
<body>

<header>
  <button id="sidebarToggle">â˜° Menu</button>
  <h1 id="storeName">Store Dashboard</h1>
</header>

<div id="sidebar">
  <ul>
    <li data-section="products">Products</li>
    <li data-section="sales">Sales</li>
    <li data-section="reports">Reports</li>
    <li data-section="settings">Settings</li>
  </ul>
</div>
<div id="sidebarOverlay"></div>

<div id="main">
  <section id="products" class="active">
    <h2>Products Overview</h2>
    <div id="productList"></div>
  </section>
  <section id="sales"><h2>Sales</h2></section>
  <section id="reports"><h2>Reports</h2></section>
  <section id="settings"><h2>Settings</h2></section>
</div>

<script>
/* --- IndexedDB helper --- */
const DB_NAME = 'StoresDB';
const DB_VERSION = 1;
let dbPromise;

function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('stores')) db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess=e=>resolve(e.target.result);
    req.onerror=e=>reject(e.target.error);
  });
  return dbPromise;
}

async function idbGet(store,key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

/* --- Sidebar logic --- */
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebarOverlay');
const toggleBtn = document.getElementById('sidebarToggle');
const sections = document.querySelectorAll('section');

toggleBtn.addEventListener('click',()=>{
  sidebar.style.left='0';
  overlay.style.display='block';
  toggleBtn.style.display='none';
});

function closeSidebar(){
  sidebar.style.left='-250px';
  overlay.style.display='none';
  toggleBtn.style.display='block';
}
overlay.addEventListener('click', closeSidebar);

document.querySelectorAll('#sidebar ul li').forEach(li=>{
  li.addEventListener('click', ()=>{
    const sectionId = li.getAttribute('data-section');
    sections.forEach(s=>s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    closeSidebar();
  });
});

/* --- Advisory system --- */
async function renderProductsAdvisory(){
  const productList = document.getElementById('productList');
  productList.innerHTML='';

  const activeStore = localStorage.getItem('activeStore');
  if(!activeStore){ productList.textContent = 'No active store selected.'; return; }

  const storeData = await idbGet('stores', activeStore);
  const products = storeData?.products || [];

  if(products.length === 0){
    const div = document.createElement('div');
    div.textContent='No products available.';
    div.style.color='#cbd5e1';
    div.style.textAlign='center';
    div.style.padding='20px';
    productList.appendChild(div);
    return;
  }

  let advisories = [];
  const today = new Date();

  products.forEach(p=>{
    const totalStock = p.batches?.reduce((sum,b)=>sum+b.quantity,0) || 0;
    if(totalStock <= (p.minStock || 0)) advisories.push(`${p.name} is low on stock (${totalStock})`);
    p.batches?.forEach(b=>{
      if(b.expiration && new Date(b.expiration) < today)
        advisories.push(`${p.name} batch ${b.lot || b.serial} has expired`);
      if(b.warranty && new Date(b.warranty) < today)
        advisories.push(`${p.name} batch ${b.lot || b.serial} warranty expired`);
    });
  });

  if(advisories.length === 0){
    const div = document.createElement('div');
    div.textContent='All products are OK.';
    div.style.color='#a3fca3';
    div.style.textAlign='center';
    div.style.padding='20px';
    productList.appendChild(div);
  } else {
    advisories.forEach(msg=>{
      const div = document.createElement('div');
      div.className='product-card';
      div.textContent=msg;
      productList.appendChild(div);
    });
  }
}

// Update dashboard header
function setStoreHeader(){
  const activeStore = localStorage.getItem('activeStore');
  if(activeStore) document.getElementById('storeName').textContent = activeStore;
}

setStoreHeader();
renderProductsAdvisory();

/* --- Service Worker --- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js',{scope:'./'})
    .then(()=>console.log('SW registered'))
    .catch(e=>console.warn('SW failed',e));
}
</script>
</body>
</html>
