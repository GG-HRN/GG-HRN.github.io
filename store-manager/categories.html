<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Categories</title>
<style>
body{margin:0;font-family:sans-serif;background:#0f1724;color:#fff;}
header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#0b1220;color:#fff;position:sticky;top:0;}
#backBtn{background:#6366f1;border:0;color:#fff;padding:6px 10px;border-radius:6px;font-weight:700;cursor:pointer;}
#headerTitle{flex:1;text-align:center;font-size:16px;font-weight:700}
main{padding:16px}
#catForm{display:flex;gap:6px;margin-bottom:12px;}
#catInput{flex:1;padding:10px;border-radius:6px;border:none;font-size:15px;}
#addBtn{padding:10px;border-radius:6px;border:none;background:#10b981;color:#fff;font-weight:700;cursor:pointer;}
.catCard{background:#1e293b;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.actions button{margin-left:6px;padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-weight:700;}
.actions .edit{background:#f59e0b;color:#fff;}
.actions .del{background:#ef4444;color:#fff;}
#catSearch{margin-bottom:12px;padding:8px;border-radius:6px;border:none;width:100%;box-sizing:border-box;}
</style>
</head>
<body>
<header>
  <button id="backBtn">‚Üê</button>
  <div id="headerTitle">Categories</div>
</header>

<main>
  <div id="catForm">
    <input type="text" id="catInput" placeholder="Enter category name"/>
    <button id="addBtn">Add</button>
  </div>
  <input type="text" id="catSearch" placeholder="Search categories...">
  <div id="catList"></div>
</main>

<script>
const DB_NAME='StoresDB',DB_VERSION=1;
let dbPromise;
const storeName = localStorage.getItem('activeStore');
let currentStore;

function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((res,rej)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('stores'))
        db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess = e => res(e.target.result);
    req.onerror = e => rej(e.target.error);
  });
  return dbPromise;
}

async function idbGet(store,key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

async function idbPut(store,value){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}

const catInput=document.getElementById('catInput');
const addBtn=document.getElementById('addBtn');
const catList=document.getElementById('catList');
const catSearch=document.getElementById('catSearch');

let categories=[];
let filteredCats=[];

document.getElementById('backBtn').addEventListener('click',()=>window.location.href="dashboard.html");

async function loadStore(){
  if(!storeName){alert("No active store"); return;}
  currentStore = await idbGet('stores',storeName);
  if(!currentStore.categories) currentStore.categories=[];
  categories = currentStore.categories;
  filteredCats = categories;
  renderCategories();
}

function renderCategories(){
  const filter = catSearch.value.trim().toLowerCase();
  filteredCats = categories.filter(c=>c.toLowerCase().includes(filter));
  catList.innerHTML = '';
  filteredCats.forEach((c,i)=>{
    const div = document.createElement('div');
    div.className='catCard';
    div.innerHTML = `
      <span>${c}</span>
      <span class="actions">
        <button class="edit">Edit</button>
        <button class="del">Delete</button>
      </span>
    `;
    div.querySelector('.edit').addEventListener('click',()=>editCategory(i));
    div.querySelector('.del').addEventListener('click',()=>deleteCategory(i));
    catList.appendChild(div);
  });
}

addBtn.addEventListener('click', async ()=>{
  const name = catInput.value.trim();
  if(!name){alert('Enter a category name'); return;}
  if(categories.includes(name)){alert('Category exists'); return;}
  categories.push(name);
  currentStore.categories = categories;
  await idbPut('stores',currentStore);
  catInput.value='';
  renderCategories();
});

function editCategory(index){
  const newName = prompt("Edit category:",categories[index]);
  if(!newName || !newName.trim()) return;
  if(categories.includes(newName) && newName!==categories[index]) {alert("Category exists"); return;}
  categories[index]=newName.trim();
  currentStore.categories = categories;
  idbPut('stores',currentStore);
  renderCategories();
}

function deleteCategory(index){
  if(!confirm("Delete this category?")) return;
  categories.splice(index,1);
  currentStore.categories = categories;
  idbPut('stores',currentStore);
  renderCategories();
}

catSearch.addEventListener('input',renderCategories);

loadStore();
</script>
</body>
</html>
