<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Categories</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Categories">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="theme-color" content="#1e293b">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f1724;color:#fff;}
header{display:flex;align-items:center;padding:12px;background:#0b1220;color:#fff;position:sticky;top:0;z-index:20}
#backBtn{margin-right:10px}
main{padding:16px}
.card{background:#1e293b;color:#fff;margin-bottom:12px;padding:12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;}
.card-title{margin:0;font-weight:bold;}
.btn-sm{padding:.25rem .5rem;font-size:.75rem;}
</style>
</head>
<body>
<header>
  <button id="backBtn" class="btn btn-primary btn-sm">← Back</button>
  <h5 class="mb-0">Categories</h5>
</header>

<main>
  <div class="mb-3">
    <input type="text" id="catName" class="form-control mb-2" placeholder="Enter category name"/>
    <button id="addCatBtn" class="btn btn-success w-100">Add Category</button>
  </div>

  <input type="text" id="catSearch" class="form-control mb-2" placeholder="Search categories...">

  <div>
    Sort by: 
    <button id="sortAsc" class="btn btn-secondary btn-sm">A→Z</button>
    <button id="sortDesc" class="btn btn-secondary btn-sm">Z→A</button>
  </div>

  <div id="catList" class="mt-3"></div>
  <div class="pagination mt-2" id="pagination"></div>
</main>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{

const DB_NAME='StoresDB',DB_VERSION=1;let dbPromise;
function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise=new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('stores'))
        db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess=e=>res(e.target.result);
    req.onerror=e=>rej(req.error);
  });
  return dbPromise;
}
async function idbGet(store,key){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}
async function idbPut(store,value){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}

/* ---- Variables ---- */
const storeName=localStorage.getItem('activeStore');
let currentStore;
const catName=document.getElementById('catName');
const catList=document.getElementById('catList');
const catSearch=document.getElementById('catSearch');
const paginationDiv=document.getElementById('pagination');
const backBtn=document.getElementById('backBtn');
const sortAscBtn=document.getElementById('sortAsc');
const sortDescBtn=document.getElementById('sortDesc');
const addCatBtn=document.getElementById('addCatBtn');

backBtn.addEventListener('click',()=>window.location.href="dashboard.html");

let filteredCats=[];
let currentPage=1;
const pageSize=5;
let sortDir='asc';

/* ---- Main ---- */
async function loadStore(){
  if(!storeName){Swal.fire('No active store'); return;}
  currentStore=await idbGet('stores',storeName);
  if(!currentStore.categories) currentStore.categories=[];
  
  // Add category event
  addCatBtn.addEventListener("click", addCategory);

  applyFilters();
}

function applyFilters(){
  const filter = catSearch.value.trim().toLowerCase();
  filteredCats=currentStore.categories.filter(c =>
    c.name.toLowerCase().includes(filter)
  );
  sortCats();
  currentPage=1;
  renderCategories();
}

function sortCats(){
  filteredCats.sort((a,b)=>{
    if(a.name.toLowerCase()<b.name.toLowerCase()) return sortDir==='asc'?-1:1;
    if(a.name.toLowerCase()>b.name.toLowerCase()) return sortDir==='asc'?1:-1;
    return 0;
  });
}

function renderCategories(){
  catList.innerHTML="";
  if(filteredCats.length===0){
    catList.innerHTML="<p>No categories found.</p>";
    paginationDiv.innerHTML="";
    return;
  }

  const start=(currentPage-1)*pageSize;
  const pageCats=filteredCats.slice(start,start+pageSize);

  pageCats.forEach((c)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <span class="card-title">${c.name}</span>
      <span>
        <button class="btn btn-warning btn-sm me-1">Edit</button>
        <button class="btn btn-danger btn-sm">Delete</button>
      </span>
    `;
    // attach events for each card
    div.querySelector(".btn-warning").addEventListener("click",()=>editCategory(currentStore.categories.indexOf(c)));
    div.querySelector(".btn-danger").addEventListener("click",()=>deleteCategory(currentStore.categories.indexOf(c)));
    catList.appendChild(div);
  });

  renderPagination();
}

function renderPagination(){
  paginationDiv.innerHTML="";
  const totalPages=Math.ceil(filteredCats.length/pageSize);
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button");
    btn.textContent=i;
    btn.className="btn btn-secondary btn-sm me-1";
    if(i===currentPage) btn.classList.add("active");
    btn.addEventListener("click",()=>{currentPage=i;renderCategories();});
    paginationDiv.appendChild(btn);
  }
}

/* ---- Add/Edit/Delete ---- */
async function addCategory(){
  const name = catName.value.trim();
  if(!name) return Swal.fire('Enter a category name');

  if(currentStore.categories.some(c=>c.name.toLowerCase()===name.toLowerCase())){
    return Swal.fire('Category already exists!');
  }

  currentStore.categories.push({name});
  await idbPut('stores',currentStore);
  catName.value="";
  applyFilters();
}

async function editCategory(index){
  const current=currentStore.categories[index];
  const { value: newName } = await Swal.fire({
    title: 'Edit category name',
    input: 'text',
    inputValue: current.name,
    showCancelButton: true
  });
  if(!newName) return;

  if(currentStore.categories.some((c,i)=>i!==index && c.name.toLowerCase()===newName.toLowerCase())){
    return Swal.fire('Another category with this name exists!');
  }

  currentStore.categories[index].name=newName.trim();
  await idbPut('stores',currentStore);
  applyFilters();
}

async function deleteCategory(index){
  const result = await Swal.fire({
    title: 'Delete this category?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Delete'
  });
  if(result.isConfirmed){
    currentStore.categories.splice(index,1);
    await idbPut('stores',currentStore);
    applyFilters();
  }
}

/* ---- Search/Sort ---- */
catSearch.addEventListener("input",applyFilters);
sortAscBtn.addEventListener("click",()=>{sortDir='asc';sortCats();renderCategories();});
sortDescBtn.addEventListener("click",()=>{sortDir='desc';sortCats();renderCategories();});

loadStore();
});
</script>
</body>
</html>
