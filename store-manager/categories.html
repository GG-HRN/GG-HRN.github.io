<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Categories</title>
<style>
  body{margin:0;font-family:sans-serif;background:#0f1724;color:#fff;padding:16px;}
  h1{text-align:center;margin-bottom:16px;}
  .input-row{display:flex;gap:8px;margin-bottom:12px;}
  .input-row input{flex:1;padding:8px;border-radius:6px;border:none;}
  .input-row button{padding:8px;border-radius:6px;border:none;background:#10b981;color:#fff;cursor:pointer;}
  #catSearch{width:100%;padding:8px;margin-bottom:12px;border-radius:6px;border:none;}
  .catCard{background:#1e293b;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
  .catName{font-weight:bold;}
  .actions button{margin-left:6px;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;}
  .actions .update{background:#f59e0b;color:#fff;}
  .actions .delete{background:#ef4444;color:#fff;}
  .pagination{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;}
  .pagination button{padding:6px 10px;border:none;border-radius:6px;background:#6366f1;color:#fff;cursor:pointer;font-weight:700;}
  .pagination button.active{background:#10b981;}
</style>
</head>
<body>

<h1>Categories</h1>

<div class="input-row">
  <input type="text" id="catName" placeholder="Category name"/>
  <button id="addBtn">Add</button>
</div>

<input type="text" id="catSearch" placeholder="Search categories...">

<div>
  Sort: <button id="sortAsc">A→Z</button>
  <button id="sortDesc">Z→A</button>
</div>

<div id="catList"></div>
<div class="pagination" id="pagination"></div>

<script>
const DB_NAME='StoresDB',DB_VERSION=1;let dbPromise;
function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise=new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('stores'))
        db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess=e=>res(e.target.result);
    req.onerror=e=>rej(e.target.error);
  });
  return dbPromise;
}
async function idbGet(store,key){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}
async function idbPut(store,value){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}

const storeName=localStorage.getItem('activeStore');
let currentStore;

const catNameInput=document.getElementById('catName');
const catList=document.getElementById('catList');
const catSearch=document.getElementById('catSearch');
const paginationDiv=document.getElementById('pagination');
const addBtn=document.getElementById('addBtn');
const sortAscBtn=document.getElementById('sortAsc');
const sortDescBtn=document.getElementById('sortDesc');

let filteredCats=[];
let currentPage=1;
const pageSize=5;
let sortDir='asc';

async function loadStore(){
  if(!storeName){alert("No active store"); return;}
  currentStore=await idbGet('stores',storeName);
  if(!currentStore.categories) currentStore.categories=[];
  applyFilters();
}

function applyFilters(){
  const filter = catSearch.value.trim().toLowerCase();
  filteredCats=currentStore.categories.filter(c=>c.name.toLowerCase().includes(filter));
  sortCats();
  currentPage=1;
  renderCategories();
}

function sortCats(){
  filteredCats.sort((a,b)=>{
    if(a.name.toLowerCase()<b.name.toLowerCase()) return sortDir==='asc'?-1:1;
    if(a.name.toLowerCase()>b.name.toLowerCase()) return sortDir==='asc'?1:-1;
    return 0;
  });
}

function renderCategories(){
  catList.innerHTML="";
  if(filteredCats.length===0){catList.innerHTML="<p>No categories found.</p>"; paginationDiv.innerHTML=""; return;}
  const start=(currentPage-1)*pageSize;
  const pageCats=filteredCats.slice(start,start+pageSize);
  pageCats.forEach(c=>{
    const div=document.createElement('div');
    div.className='catCard';
    div.innerHTML=`
      <span class="catName">${c.name}</span>
      <span class="actions">
        <button class="update">Edit</button>
        <button class="delete">Delete</button>
      </span>
    `;
    div.querySelector(".update").addEventListener("click",()=>editCategory(currentStore.categories.indexOf(c)));
    div.querySelector(".delete").addEventListener("click",()=>deleteCategory(currentStore.categories.indexOf(c)));
    catList.appendChild(div);
  });
  renderPagination();
}

function renderPagination(){
  paginationDiv.innerHTML="";
  const totalPages=Math.ceil(filteredCats.length/pageSize);
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button");
    btn.textContent=i;
    if(i===currentPage) btn.classList.add("active");
    btn.addEventListener("click",()=>{currentPage=i;renderCategories();});
    paginationDiv.appendChild(btn);
  }
}

addBtn.addEventListener('click', async ()=>{
  const name=catNameInput.value.trim();
  if(!name){alert("Enter category name"); return;}
  if(currentStore.categories.some(c=>c.name.toLowerCase()===name.toLowerCase())){alert("Category exists"); return;}
  currentStore.categories.push({name});
  await idbPut('stores',currentStore);
  catNameInput.value="";
  applyFilters();
});

async function editCategory(index){
  const current=currentStore.categories[index];
  const newName=prompt("Edit category name:",current.name);
  if(!newName||!newName.trim()) return;
  if(currentStore.categories.some((c,i)=>i!==index && c.name.toLowerCase()===newName.toLowerCase())){alert("Duplicate name"); return;}
  currentStore.categories[index].name=newName.trim();
  await idbPut('stores',currentStore);
  applyFilters();
}

async function deleteCategory(index){
  if(!confirm("Delete this category?")) return;
  currentStore.categories.splice(index,1);
  await idbPut('stores',currentStore);
  applyFilters();
}

catSearch.addEventListener('input',applyFilters);
sortAscBtn.addEventListener('click',()=>{sortDir='asc';sortCats();renderCategories();});
sortDescBtn.addEventListener('click',()=>{sortDir='desc';sortCats();renderCategories();});

loadStore();
</script>

</body>
</html>
