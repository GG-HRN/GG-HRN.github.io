<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Products</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Products">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="theme-color" content="#1e293b">
<link rel="icon" href="icons/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="icons/favicon-16x16.png" sizes="16x16">

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{background:#0f1724;color:#fff;font-family:sans-serif;margin:0}
header{background:#0b1220;color:#fff;padding:12px;display:flex;align-items:center}
#backBtn{margin-right:10px}
.card{background:#1e293b;color:#fff}
.swal2-popup{font-size:14px !important}
.muted{color:#94a3b8}
.hidden{display:none;}
.prodCard{background:#1e293b;color:#fff;border-radius:8px;padding:12px;margin-bottom:10px;}
.prodName{font-weight:bold}
.prodDetail{font-size:0.85rem;color:#cbd5e1;margin:2px 0}
.actions{margin-top:4px}
.actions button{margin-right:6px}
.pagination{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.pagination button{padding:6px 10px;border:none;border-radius:6px;background:#6366f1;color:#fff;cursor:pointer;font-weight:700}
.pagination button.active{background:#10b981}
</style>
</head>
<body>
<header>
  <button id="backBtn" class="btn btn-sm btn-primary">‚Üê Back</button>
  <h5 class="m-0 w-100 text-center">Products</h5>
</header>

<main class="container py-3">
  <form id="prodForm" class="mb-3" autocomplete="off">
    <input type="text" id="prodName" class="form-control mb-2" placeholder="Product name *" required>
    
    <select id="prodBrand" class="form-select mb-2" required>
      <option value="">Select a brand...</option>
    </select>
    <select id="prodCategory" class="form-select mb-2" required>
      <option value="">Select a category...</option>
    </select>
    <select id="prodSubcategory" class="form-select mb-2" required>
      <option value="">Select a subcategory...</option>
    </select>

    <input type="number" id="prodPrice" class="form-control mb-2" placeholder="Price *" min="0" step="0.01" required>
    <input type="number" id="prodCost" class="form-control mb-2" placeholder="Cost *" min="0" step="0.01" required>

    <div class="form-check form-check-inline">
      <input class="form-check-input" type="checkbox" id="chkWarranty">
      <label class="form-check-label text-white" for="chkWarranty">Warranty</label>
    </div>
    <div class="form-check form-check-inline mb-2">
      <input class="form-check-input" type="checkbox" id="chkExpiration">
      <label class="form-check-label text-white" for="chkExpiration">Expiration/Lot</label>
    </div>

    <div id="warrantyFields" class="hidden mb-2">
      <input type="text" id="prodSerial" class="form-control mb-2" placeholder="Serial number">
      <input type="date" id="prodWarrantyDate" class="form-control mb-2">
      <input type="number" id="prodQuantity" class="form-control mb-2" value="1" min="1" readonly>
    </div>

    <div id="expirationFields" class="hidden mb-2">
      <input type="date" id="prodExpirationDate" class="form-control mb-2" placeholder="Expiration Date">
      <input type="text" id="prodLot" class="form-control mb-2" placeholder="Lot">
      <input type="number" id="prodQuantityExp" class="form-control mb-2" value="1" min="1">
    </div>

    <div id="normalQuantity" class="mb-2">
      <input type="number" id="prodQuantityNorm" class="form-control" value="1" min="1">
    </div>

    <button type="submit" class="btn btn-success">Save Product</button>
  </form>

  <input type="text" id="prodSearch" class="form-control mb-3" placeholder="Search products...">
  <div id="prodList" class="mb-2"></div>
  <div class="d-flex flex-wrap gap-2 mt-3" id="pagination"></div>
</main>

<script>
const DB_NAME='StoresDB',DB_VERSION=2;
let db, storeObj, products=[], brands=[], categories=[], subcategories=[], filtered=[], currentPage=1, pageSize=5;
const storeName=localStorage.getItem('activeStore'); if(!storeName){alert("No active store"); throw 'No store';}

// Elements
const prodForm=document.getElementById('prodForm'), prodName=document.getElementById('prodName');
const prodBrand=document.getElementById('prodBrand'), prodCategory=document.getElementById('prodCategory'), prodSubcategory=document.getElementById('prodSubcategory');
const prodPrice=document.getElementById('prodPrice'), prodCost=document.getElementById('prodCost');
const chkWarranty=document.getElementById('chkWarranty'), chkExpiration=document.getElementById('chkExpiration');
const warrantyFields=document.getElementById('warrantyFields'), expirationFields=document.getElementById('expirationFields');
const prodSerial=document.getElementById('prodSerial'), prodWarrantyDate=document.getElementById('prodWarrantyDate');
const prodExpirationDate=document.getElementById('prodExpirationDate'), prodLot=document.getElementById('prodLot');
const prodQuantity=document.getElementById('prodQuantity'), prodQuantityExp=document.getElementById('prodQuantityExp'), prodQuantityNorm=document.getElementById('prodQuantityNorm');
const prodSearch=document.getElementById('prodSearch'), prodList=document.getElementById('prodList'), paginationDiv=document.getElementById('pagination');
const backBtn=document.getElementById('backBtn'); backBtn.addEventListener('click',()=>window.location.href="dashboard.html");

// IndexedDB
const request=indexedDB.open(DB_NAME,DB_VERSION);
request.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains('stores')) db.createObjectStore('stores',{keyPath:'name'});}
request.onsuccess=e=>{db=e.target.result; loadStore();}
request.onerror=e=>console.error('DB error',e);

// Load store
function loadStore(){
  const tx=db.transaction('stores','readonly'); 
  tx.objectStore('stores').get(storeName).onsuccess=e=>{
    storeObj=e.target.result; 
    if(!storeObj){
      storeObj={name:storeName,brands:[],categories:[],subcategories:[],products:[]};
      const tx2=db.transaction('stores','readwrite'); tx2.objectStore('stores').put(storeObj);
    }
    brands=storeObj.brands||[]; 
    categories=storeObj.categories||[]; 
    subcategories=storeObj.subcategories||[]; 
    products=storeObj.products||[];
    fillSelects(); renderProducts();
  };
}

// Fill selects
function fillSelects(){
  prodBrand.innerHTML='<option value="">Select a brand...</option>';
  brands.forEach(b=>{const o=document.createElement('option'); o.value=o.textContent=b; prodBrand.appendChild(o);});
  prodCategory.innerHTML='<option value="">Select a category...</option>';
  categories.forEach(c=>{const o=document.createElement('option'); o.value=o.textContent=c.name; prodCategory.appendChild(o);});
  prodSubcategory.innerHTML='<option value="">Select a subcategory...</option>';
}

prodCategory.addEventListener('change',()=>{
  const cat=prodCategory.value;
  const filteredSubs=subcategories.filter(s=>s.category===cat).map(s=>s.name);
  prodSubcategory.innerHTML='<option value="">Select a subcategory...</option>';
  filteredSubs.forEach(name=>{const o=document.createElement('option'); o.value=o.textContent=name; prodSubcategory.appendChild(o);});
});

// Toggle fields
chkWarranty.addEventListener('change',()=>{
  warrantyFields.classList.toggle('hidden',!chkWarranty.checked);
  if(chkWarranty.checked){ chkExpiration.checked=false; expirationFields.classList.add('hidden'); prodQuantity.value=1; prodQuantity.readOnly=true; prodQuantityNorm.classList.add('hidden'); }
  else{ prodQuantity.readOnly=false; prodQuantityNorm.classList.remove('hidden'); }
});
chkExpiration.addEventListener('change',()=>{
  expirationFields.classList.toggle('hidden',!chkExpiration.checked);
  if(chkExpiration.checked){ chkWarranty.checked=false; warrantyFields.classList.add('hidden'); prodQuantityNorm.classList.add('hidden'); }
  else{ prodQuantityNorm.classList.remove('hidden'); }
});

// Add product
prodForm.addEventListener('submit', e=>{
  e.preventDefault();
  const p={
    name: prodName.value.trim(),
    brand: prodBrand.value,
    category: prodCategory.value,
    subcategory: prodSubcategory.value,
    price: parseFloat(prodPrice.value),
    cost: parseFloat(prodCost.value),
    warranty: chkWarranty.checked,
    expiration: chkExpiration.checked,
    serial: prodSerial.value,
    warrantyDate: prodWarrantyDate.value,
    expirationDate: prodExpirationDate.value,
    lot: prodLot.value,
    quantity: chkWarranty.checked?1:(chkExpiration.checked?parseInt(prodQuantityExp.value):parseInt(prodQuantityNorm.value))
  };
  if(!p.name||!p.brand||!p.category||!p.subcategory||!p.price||!p.cost){
    Swal.fire({icon:'warning',title:'Required',text:'Fill all required fields'}); return;
  }

  // Add brand/category/subcategory if missing
  if(!brands.includes(p.brand)){brands.push(p.brand); storeObj.brands=brands;}
  if(!categories.some(c=>c.name===p.category)){categories.push({name:p.category}); storeObj.categories=categories;}
  if(!subcategories.some(s=>s.name===p.subcategory && s.category===p.category)){subcategories.push({name:p.subcategory,category:p.category}); storeObj.subcategories=subcategories;}

  // Determine if duplicate
  let foundIndex=-1;
  if(!p.warranty){
    foundIndex=products.findIndex(pr=>{
      if(p.expiration){
        return pr.name===p.name && pr.brand===p.brand && pr.category===p.category && pr.subcategory===p.subcategory
          && pr.price===p.price && pr.cost===p.cost && pr.expiration && pr.expirationDate===p.expirationDate && pr.lot===p.lot;
      }else{
        return pr.name===p.name && pr.brand===p.brand && pr.category===p.category && pr.subcategory===p.subcategory
          && pr.price===p.price && pr.cost===p.cost && !pr.warranty && !pr.expiration;
      }
    });
  } else { // warranty always new
    if(products.some(pr=>pr.warranty && pr.serial===p.serial && pr.warrantyDate===p.warrantyDate)){
      Swal.fire({icon:'error',title:'Duplicate',text:'Serial number must be unique'}); return;
    }
  }

  if(foundIndex>=0){ products[foundIndex].quantity+=p.quantity; } else { products.push(p); }
  storeObj.products=products;
  const tx=db.transaction('stores','readwrite'); tx.objectStore('stores').put(storeObj);
  prodForm.reset(); chkWarranty.checked=false; chkExpiration.checked=false;
  warrantyFields.classList.add('hidden'); expirationFields.classList.add('hidden'); prodQuantityNorm.classList.remove('hidden');
  fillSelects(); renderProducts();
});

// Render products
function renderProducts(){
  const filter=prodSearch.value.trim().toLowerCase();
  filtered=products.filter(p=>p.name.toLowerCase().includes(filter));
  const totalPages=Math.ceil(filtered.length/pageSize);
  const start=(currentPage-1)*pageSize;
  const pageItems=filtered.slice(start,start+pageSize);
  prodList.innerHTML='';
  if(pageItems.length===0){prodList.innerHTML="<p class='muted'>No products found.</p>"; paginationDiv.innerHTML=''; return;}
  pageItems.forEach((p,i)=>{
    const div=document.createElement('div'); div.className='prodCard';
    div.innerHTML=`
      <div class="prodName">${p.name}</div>
      <div class="prodDetail">Brand: ${p.brand} | Category: ${p.category} | Sub: ${p.subcategory}</div>
      <div class="prodDetail">Price: $${p.price} | Cost: $${p.cost} | Qty: ${p.quantity}</div>
      ${p.warranty?`<div class="prodDetail">Warranty: ${p.serial} / ${p.warrantyDate}</div>`:''}
      ${p.expiration?`<div class="prodDetail">Exp: ${p.expirationDate} | Lot: ${p.lot}</div>`:''}
      <div class="actions">
        <button class="btn btn-sm btn-warning me-1" onclick="editProduct(${i})">Edit</button>
        <button class="btn btn-sm btn-danger me-1" onclick="deleteProduct(${i})">Delete</button>
        <button class="btn btn-sm btn-success" onclick="increaseQuantity(${i})">+</button>
      </div>
    `;
    prodList.appendChild(div);
  });
  paginationDiv.innerHTML='';
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement('button');btn.className='btn btn-sm '+(i===currentPage?'btn-success':'btn-primary');btn.textContent=i;
    btn.addEventListener('click',()=>{currentPage=i;renderProducts();});
    paginationDiv.appendChild(btn);
  }
}

function editProduct(index){
  const p=products[index];
  prodName.value=p.name; prodBrand.value=p.brand; prodCategory.value=p.category;
  prodPrice.value=p.price; prodCost.value=p.cost;
  chkWarranty.checked=p.warranty; chkExpiration.checked=p.expiration;
  warrantyFields.classList.toggle('hidden',!p.warranty); expirationFields.classList.toggle('hidden',!p.expiration);
  prodSerial.value=p.serial; prodWarrantyDate.value=p.warrantyDate;
  prodExpirationDate.value=p.expirationDate; prodLot.value=p.lot;
  prodQuantity.value=p.quantity; prodQuantityExp.value=p.quantity; prodQuantityNorm.value=p.quantity;
}

function deleteProduct(index){
  if(confirm("Delete product?")){
    products.splice(index,1); storeObj.products=products;
    const tx=db.transaction('stores','readwrite'); tx.objectStore('stores').put(storeObj);
    renderProducts();
  }
}

function increaseQuantity(index){
  products[index].quantity++;
  storeObj.products=products;
  const tx=db.transaction('stores','readwrite'); tx.objectStore('stores').put(storeObj);
  renderProducts();
}

prodSearch.addEventListener('input',()=>{currentPage=1; renderProducts();});

// Service Worker
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js',{scope:'./'}).then(()=>console.log('SW registered')).catch(e=>console.warn('SW failed',e));}
</script>
</body>
</html>
