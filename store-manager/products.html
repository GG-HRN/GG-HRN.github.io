<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Manager - Products</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; }
header { background:#1e293b; color:white; padding:1rem; text-align:center; }
.container { padding:1rem; max-width:800px; margin:auto; }
input, select, button { padding:0.5rem; margin:0.3rem 0; width:100%; box-sizing:border-box; }
label { display:block; margin-top:0.5rem; }
.card { background:white; padding:1rem; margin:0.5rem 0; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.actions button { margin-right:0.5rem; }
.hidden { display:none; }
.prodDetail { font-size:0.85rem; color:#555; }
#pagination button { margin:0 0.2rem; }
#pagination button.active { background:#1e293b; color:white; }
</style>
</head>
<body>

<header><h1>Stock Manager - Products</h1></header>

<div class="container">
  <h2>Add / Edit Product</h2>
  <form id="prodForm">
    <label>Name *</label>
    <input type="text" id="prodName" required>
    <label>Brand *</label>
    <select id="prodBrand"></select>
    <label>Category *</label>
    <select id="prodCategory"></select>
    <label>Subcategory *</label>
    <select id="prodSubcategory"></select>
    <label>Price *</label>
    <input type="number" id="prodPrice" min="0" step="0.01" required>
    <label>Cost *</label>
    <input type="number" id="prodCost" min="0" step="0.01" required>

    <div style="display:flex; gap:1rem; margin-top:0.5rem;">
      <label><input type="checkbox" id="chkWarranty"> Warranty</label>
      <label><input type="checkbox" id="chkExpiration"> Expiration</label>
    </div>

    <div id="warrantyFields" class="hidden">
      <label>Serial Number</label>
      <input type="text" id="prodSerial">
      <label>Warranty Date</label>
      <input type="date" id="prodWarrantyDate">
    </div>

    <div id="expirationFields" class="hidden">
      <label>Expiration Date</label>
      <input type="date" id="prodExpirationDate">
      <label>Lot Number</label>
      <input type="text" id="prodLot">
      <label>Quantity</label>
      <input type="number" id="prodQuantity" min="1" value="1">
    </div>

    <button type="submit">Save Product</button>
  </form>

  <h2>Products</h2>
  <input type="text" id="prodSearch" placeholder="Search products...">
  <div id="prodList"></div>
  <div id="pagination"></div>
</div>

<script>
// IndexedDB setup
let db;
const request = indexedDB.open('stockManagerDB',1);
request.onupgradeneeded = e=>{
  db = e.target.result;
  if(!db.objectStoreNames.contains('products')){
    db.createObjectStore('products',{keyPath:'id',autoIncrement:true});
  }
};
request.onsuccess = e=>{
  db = e.target.result;
  loadProducts();
};
request.onerror = e=>{
  console.error('IndexedDB error', e);
};

// Mock brands/categories/subcategories
const brands = ["Brand A","Brand B"];
const categories = ["Category X","Category Y"];
const subcategories = ["Subcat 1","Subcat 2"];
function fillSelect(id, arr){
  const sel = document.getElementById(id);
  sel.innerHTML='';
  arr.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v; opt.textContent=v;
    sel.appendChild(opt);
  });
}
fillSelect('prodBrand',brands);
fillSelect('prodCategory',categories);
fillSelect('prodSubcategory',subcategories);

// Elements
const chkWarranty = document.getElementById('chkWarranty');
const chkExpiration = document.getElementById('chkExpiration');
const warrantyFields = document.getElementById('warrantyFields');
const expirationFields = document.getElementById('expirationFields');
const prodForm = document.getElementById('prodForm');
const prodList = document.getElementById('prodList');
const prodSearch = document.getElementById('prodSearch');
const paginationDiv = document.getElementById('pagination');

chkWarranty.addEventListener('change',()=>{
  warrantyFields.classList.toggle('hidden',!chkWarranty.checked);
  if(chkWarranty.checked){ chkExpiration.checked=false; expirationFields.classList.add('hidden'); }
});
chkExpiration.addEventListener('change',()=>{
  expirationFields.classList.toggle('hidden',!chkExpiration.checked);
  if(chkExpiration.checked){ chkWarranty.checked=false; warrantyFields.classList.add('hidden'); }
});

// Product list
let products=[];
let filteredProducts=[];
let currentPage=1;
const pageSize=5;

function loadProducts(){
  const tx=db.transaction('products','readonly');
  const store=tx.objectStore('products');
  const all=store.getAll();
  all.onsuccess=e=>{
    products=e.target.result;
    filteredProducts=[...products];
    renderPage();
  };
}

function saveProductToDB(prod){
  const tx=db.transaction('products','readwrite');
  const store=tx.objectStore('products');
  store.put(prod);
  tx.oncomplete=()=>loadProducts();
}

function deleteProductFromDB(id){
  const tx=db.transaction('products','readwrite');
  const store=tx.objectStore('products');
  store.delete(id);
  tx.oncomplete=()=>loadProducts();
}

// Filtering
prodSearch.addEventListener('input',()=>{ currentPage=1; applyFilters(); });

function applyFilters(){
  const search=prodSearch.value.toLowerCase();
  filteredProducts=products.filter(p=>p.name.toLowerCase().includes(search));
  renderPage();
}

function renderPage(){
  const start=(currentPage-1)*pageSize;
  const pageProducts=filteredProducts.slice(start,start+pageSize);
  prodList.innerHTML='';
  if(pageProducts.length===0){ prodList.innerHTML='<p style="text-align:center;color:#aaa">No products available.</p>'; paginationDiv.innerHTML=''; return; }
  pageProducts.forEach((p,i)=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div>
        <strong>${p.name}</strong>
        <div class="prodDetail">Brand: ${p.brand} | Category: ${p.category} | Sub: ${p.subcategory}</div>
        <div class="prodDetail">Price: $${p.price} | Cost: $${p.cost}</div>
        ${p.warranty?`<div class="prodDetail">Warranty: ${p.serial} / ${p.warrantyDate}</div>`:''}
        ${p.expiration?`<div class="prodDetail">Exp: ${p.expirationDate} | Lot: ${p.lot} | Qty: ${p.quantity}</div>`:''}
      </div>
      <div class="actions">
        <button onclick="editProduct(${p.id})">Edit</button>
        <button onclick="deleteProduct(${p.id})">Delete</button>
      </div>`;
    prodList.appendChild(card);
  });
  renderPagination();
}

function renderPagination(){
  const totalPages=Math.ceil(filteredProducts.length/pageSize);
  paginationDiv.innerHTML='';
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement('button');
    btn.textContent=i; btn.className=i===currentPage?'active':'';
    btn.onclick=()=>{ currentPage=i; renderPage(); };
    paginationDiv.appendChild(btn);
  }
}

prodForm.onsubmit=e=>{
  e.preventDefault();
  const prod={
    id:Date.now(),
    name:document.getElementById('prodName').value.trim(),
    brand:document.getElementById('prodBrand').value,
    category:document.getElementById('prodCategory').value,
    subcategory:document.getElementById('prodSubcategory').value,
    price:parseFloat(document.getElementById('prodPrice').value),
    cost:parseFloat(document.getElementById('prodCost').value),
    warranty:chkWarranty.checked,
    expiration:chkExpiration.checked,
    serial:document.getElementById('prodSerial').value.trim(),
    warrantyDate:document.getElementById('prodWarrantyDate').value,
    expirationDate:document.getElementById('prodExpirationDate').value,
    lot:document.getElementById('prodLot').value.trim(),
    quantity:parseInt(document.getElementById('prodQuantity').value)||1
  };
  saveProductToDB(prod);
  prodForm.reset();
  warrantyFields.classList.add('hidden');
  expirationFields.classList.add('hidden');
};

// Edit function
function editProduct(id){
  const prod=products.find(p=>p.id===id);
  if(!prod) return;
  document.getElementById('prodName').value=prod.name;
  document.getElementById('prodBrand').value=prod.brand;
  document.getElementById('prodCategory').value=prod.category;
  document.getElementById('prodSubcategory').value=prod.subcategory;
  document.getElementById('prodPrice').value=prod.price;
  document.getElementById('prodCost').value=prod.cost;
  if(prod.warranty){ chkWarranty.checked=true; warrantyFields.classList.remove('hidden'); document.getElementById('prodSerial').value=prod.serial; document.getElementById('prodWarrantyDate').value=prod.warrantyDate;}
  if(prod.expiration){ chkExpiration.checked=true; expirationFields.classList.remove('hidden'); document.getElementById('prodExpirationDate').value=prod.expirationDate; document.getElementById('prodLot').value=prod.lot; document.getElementById('prodQuantity').value=prod.quantity;}
  deleteProductFromDB(id);
}

// Delete
function deleteProduct(id){
  if(confirm('Delete this product?')) deleteProductFromDB(id);
}

// Register service worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(reg=>console.log('SW registered')).catch(err=>console.log('SW error',err));
}

</script>
</body>
</html>
