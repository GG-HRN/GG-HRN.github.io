<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Products</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Products">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="theme-color" content="#1e293b">
<link rel="icon" href="icons/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="icons/favicon-16x16.png" sizes="16x16">

<style>
body{margin:0;font-family:sans-serif;background:#0f1724;color:#fff;}
header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#0b1220;color:#fff;position:sticky;top:0;z-index:20;}
#backBtn{background:#6366f1;border:0;color:#fff;padding:6px 10px;border-radius:6px;font-weight:700;cursor:pointer;}
#headerTitle{flex:1;text-align:center;font-size:16px;font-weight:700}

main{padding:16px}

form{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
input,select,textarea,button{
  width:100%;
  padding:14px;
  margin-bottom:10px;
  border-radius:8px;
  font-size:16px;
  box-sizing:border-box;
  border:none;
}
textarea{resize:vertical;min-height:60px}
button{cursor:pointer;font-weight:700;padding:12px;font-size:16px}
button.add{background:#10b981;color:#fff}
button.update{background:#f59e0b;color:#fff}
button.delete{background:#ef4444;color:#fff}

#prodSearch{margin-bottom:12px;padding:12px;border-radius:8px;border:none;width:100%;box-sizing:border-box}

.prodCard{background:#1e293b;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.prodInfo{flex:1}
.prodName{font-weight:bold;display:block;margin-bottom:4px}
.prodDetail{font-size:12px;color:#aaa}
.actions button{margin-left:6px}

.pagination{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.pagination button{padding:6px 10px;border:none;border-radius:6px;background:#6366f1;color:#fff;cursor:pointer;font-weight:700}
.pagination button.active{background:#10b981}

.hidden{display:none}

/* Checkbox layout */
.inline-checkboxes{
  display:flex;
  gap:20px;
  margin-bottom:12px;
  flex-wrap:wrap;
}
.inline-checkboxes label{
  display:flex;
  flex-direction:column; /* label below checkbox */
  align-items:flex-start;
  font-size:14px;
  cursor:pointer;
}
</style>
</head>
<body>
<header>
  <button id="backBtn">‚Üê</button>
  <div id="headerTitle">Products</div>
</header>

<main>
<form id="prodForm">
  <input type="text" id="prodName" placeholder="Product Name" required/>
  <select id="prodCategory" required></select>
  <select id="prodSubcategory" required></select>
  <select id="prodBrand" required></select>
  <input type="number" id="prodPrice" placeholder="Price" step="0.01" required/>
  <input type="number" id="prodCost" placeholder="Cost" step="0.01" required/>

  <div class="inline-checkboxes">
    <label><input type="checkbox" id="chkWarranty"/> Warranty</label>
    <label><input type="checkbox" id="chkExpiration"/> Expiration</label>
  </div>

  <div id="warrantyFields" class="hidden">
    <input type="text" id="prodSerial" placeholder="Serial Number"/>
    <input type="date" id="prodWarrantyDate"/>
  </div>

  <div id="expirationFields" class="hidden">
    <input type="date" id="prodExpirationDate"/>
    <input type="text" id="prodLot" placeholder="Lot Number"/>
    <input type="number" id="prodQuantity" placeholder="Quantity"/>
  </div>

  <button type="submit" class="add">Add Product</button>
</form>

<input type="text" id="prodSearch" placeholder="Search products...">

<div id="prodList"></div>
<div class="pagination" id="pagination"></div>
</main>

<script>
/* IndexedDB helpers */
const DB_NAME='StoresDB',DB_VERSION=1;let dbPromise;
function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise=new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('stores'))
        db.createObjectStore('stores',{keyPath:'name'});
    };
    req.onsuccess=e=>res(e.target.result);
    req.onerror=e=>rej(e.target.error);
  });
  return dbPromise;
}
async function idbGet(store,key){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}
async function idbPut(store,value){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}

/* Logic */
const storeName=localStorage.getItem('activeStore');
let currentStore;
const prodForm=document.getElementById('prodForm');
const prodName=document.getElementById('prodName');
const prodCategory=document.getElementById('prodCategory');
const prodSubcategory=document.getElementById('prodSubcategory');
const prodBrand=document.getElementById('prodBrand');
const prodPrice=document.getElementById('prodPrice');
const prodCost=document.getElementById('prodCost');
const chkWarranty=document.getElementById('chkWarranty');
const chkExpiration=document.getElementById('chkExpiration');
const warrantyFields=document.getElementById('warrantyFields');
const expirationFields=document.getElementById('expirationFields');
const prodSerial=document.getElementById('prodSerial');
const prodWarrantyDate=document.getElementById('prodWarrantyDate');
const prodExpirationDate=document.getElementById('prodExpirationDate');
const prodLot=document.getElementById('prodLot');
const prodQuantity=document.getElementById('prodQuantity');
const prodList=document.getElementById('prodList');
const prodSearch=document.getElementById('prodSearch');
const paginationDiv=document.getElementById('pagination');
const backBtn=document.getElementById('backBtn');

backBtn.addEventListener('click',()=>window.location.href="dashboard.html");

let filteredProducts=[];
let currentPage=1;
const pageSize=5;
let sortDir='asc';

/* Load store & populate dropdowns */
async function loadStore(){
  if(!storeName){alert("No active store");return;}
  currentStore=await idbGet('stores',storeName);
  if(!currentStore.products) currentStore.products=[];
  if(!currentStore.categories) currentStore.categories=[];
  if(!currentStore.subcategories) currentStore.subcategories=[];
  if(!currentStore.brands) currentStore.brands=[];
  populateSelect(prodCategory,currentStore.categories,"Select Category");
  populateSelect(prodBrand,currentStore.brands,"Select Brand");
  prodCategory.addEventListener("change",()=>populateSelect(prodSubcategory,currentStore.subcategories.filter(s=>s.categoryName===prodCategory.value),"Select Subcategory"));
  applyFilters();
}
function populateSelect(select,arr,placeholder){
  select.innerHTML=`<option value="">${placeholder}</option>`;
  arr.forEach(a=>{
    select.appendChild(Object.assign(document.createElement("option"),{value:a.name||a,textContent:a.name||a}));
  });
}

/* Checkbox logic: mutually exclusive */
chkWarranty.addEventListener("change",()=>{
  if(chkWarranty.checked) chkExpiration.checked=false;
  warrantyFields.classList.toggle("hidden",!chkWarranty.checked);
  expirationFields.classList.add("hidden");
});
chkExpiration.addEventListener("change",()=>{
  if(chkExpiration.checked) chkWarranty.checked=false;
  expirationFields.classList.toggle("hidden",!chkExpiration.checked);
  warrantyFields.classList.add("hidden");
});

/* Filters, pagination, rendering, add/edit/delete logic remain same as previous version */
</script>
  <script>
let products = currentStore.products || [];
let currentPage = 1;
const pageSize = 5;
let sortField = 'name';
let sortDir = 'asc';

const prodList = document.getElementById('prodList');
const prodSearch = document.getElementById('prodSearch');
const paginationDiv = document.getElementById('pagination');

// Filter products based on search input
function applyFilters() {
  const search = prodSearch.value.toLowerCase();
  filteredProducts = products.filter(p =>
    p.name.toLowerCase().includes(search)
  );
  renderPage();
}

// Render current page with pagination
function renderPage() {
  const start = (currentPage - 1) * pageSize;
  const pageProducts = filteredProducts.slice(start, start + pageSize);
  prodList.innerHTML = '';
  if(pageProducts.length === 0){
    prodList.innerHTML = `<p style="text-align:center;color:#aaa">No products available.</p>`;
    paginationDiv.innerHTML = '';
    return;
  }

  pageProducts.forEach((p,i)=>{
    const card = document.createElement('div');
    card.className = 'prodCard';
    card.innerHTML = `
      <div class="prodInfo">
        <span class="prodName">${p.name}</span>
        <span class="prodDetail">Brand: ${p.brand} | Category: ${p.category} | Sub: ${p.subcategory}</span>
        <span class="prodDetail">Price: $${p.price} | Cost: $${p.cost}</span>
        ${p.warranty ? `<span class="prodDetail">Warranty: ${p.serial} / ${p.warrantyDate}</span>` : ''}
        ${p.expiration ? `<span class="prodDetail">Expiration: ${p.expirationDate} | Lot: ${p.lot} | Qty: ${p.quantity}</span>` : ''}
      </div>
      <div class="actions">
        <button onclick="editProduct(${i+start})" class="update">Edit</button>
        <button onclick="deleteProduct(${i+start})" class="delete">Delete</button>
      </div>
    `;
    prodList.appendChild(card);
  });
  renderPagination();
}

// Pagination buttons
function renderPagination(){
  const totalPages = Math.ceil(filteredProducts.length / pageSize);
  paginationDiv.innerHTML = '';
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = i===currentPage ? 'active':'';
    btn.onclick = ()=>{ currentPage=i; renderPage(); };
    paginationDiv.appendChild(btn);
  }
}

// Add product with rules
prodForm.onsubmit = (e)=>{
  e.preventDefault();
  const name = prodName.value.trim();
  const category = prodCategory.value;
  const subcategory = prodSubcategory.value;
  const brand = prodBrand.value;
  const price = parseFloat(prodPrice.value);
  const cost = parseFloat(prodCost.value);
  const warranty = chkWarranty.checked;
  const expiration = chkExpiration.checked;
  const serial = prodSerial.value.trim();
  const warrantyDate = prodWarrantyDate.value;
  const expirationDate = prodExpirationDate.value;
  const lot = prodLot.value.trim();
  let quantity = parseInt(prodQuantity.value)||1;

  if(!name || !category || !subcategory || !brand || !price || !cost){
    return alert('Please fill all required fields.');
  }

  // Duplication logic
  let existingIndex = -1;
  if(warranty){
    quantity=1;
  } else if(expiration){
    existingIndex = products.findIndex(p=>
      p.name===name &&
      p.price===price &&
      p.cost===cost &&
      p.category===category &&
      p.subcategory===subcategory &&
      p.brand===brand &&
      p.expiration && p.expirationDate===expirationDate && p.lot===lot
    );
  } else {
    existingIndex = products.findIndex(p=>
      p.name===name &&
      p.price===price &&
      p.cost===cost &&
      p.category===category &&
      p.subcategory===subcategory &&
      p.brand===brand &&
      !p.expiration && !p.warranty
    );
  }

  const newProduct = {name, category, subcategory, brand, price, cost, warranty, expiration, serial, warrantyDate, expirationDate, lot, quantity};

  if(existingIndex>=0){
    products[existingIndex].quantity += quantity;
  } else {
    products.push(newProduct);
  }

  saveProducts();
  clearForm();
  applyFilters();
};

// Save to IndexedDB
function saveProducts(){
  currentStore.products = products;
  idbPut('stores',currentStore);
}

// Clear form inputs
function clearForm(){
  prodName.value='';
  prodPrice.value='';
  prodCost.value='';
  prodSerial.value='';
  prodWarrantyDate.value='';
  prodExpirationDate.value='';
  prodLot.value='';
  prodQuantity.value='';
  chkWarranty.checked=false;
  chkExpiration.checked=false;
  warrantyFields.classList.add('hidden');
  expirationFields.classList.add('hidden');
}

// Edit product
function editProduct(i){
  const p = products[i];
  prodName.value = p.name;
  prodCategory.value = p.category;
  prodSubcategory.value = p.subcategory;
  prodBrand.value = p.brand;
  prodPrice.value = p.price;
  prodCost.value = p.cost;
  if(p.warranty){
    chkWarranty.checked=true;
    warrantyFields.classList.remove('hidden');
    prodSerial.value=p.serial;
    prodWarrantyDate.value=p.warrantyDate;
  }
  if(p.expiration){
    chkExpiration.checked=true;
    expirationFields.classList.remove('hidden');
    prodExpirationDate.value=p.expirationDate;
    prodLot.value=p.lot;
    prodQuantity.value=p.quantity;
  }
  // Remove old entry
  products.splice(i,1);
  saveProducts();
  applyFilters();
}

// Delete product
function deleteProduct(i){
  if(confirm('Delete this product?')){
    products.splice(i,1);
    saveProducts();
    applyFilters();
  }
}

// Event listeners
prodSearch.addEventListener('input',()=>{
  currentPage=1;
  applyFilters();
});

// Initial load
applyFilters();
</script>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.log('SW registration failed', err));
  });
}

// Example: send JSON data to SW to cache dynamically
function cacheJSON(url, data){
  if(navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({
      type:'CACHE_JSON',
      url,
      data
    });
  }
}
</script>
</body>
</html>
