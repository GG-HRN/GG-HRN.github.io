<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Workout Planner</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Planner">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  body{margin:0;font-family:system-ui,Arial;background:#0f1724;color:#fff;display:flex;justify-content:center;padding:20px}
  .app{width:100%;max-width:900px;background:#1e293b;padding:20px;border-radius:12px}
  h1{text-align:center;margin-bottom:12px}
  .input-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;position:relative}
  input,select,button{padding:8px;border-radius:8px;border:0;font-size:14px}
  button.add-btn{background:#6366f1;color:#fff;font-weight:700}
  .week{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  .day{background:#334155;padding:12px;border-radius:8px}
  .exercise{background:#475569;margin-bottom:6px;padding:6px;border-radius:6px;font-size:14px}
  .autocomplete-list{position:absolute;top:40px;left:0;right:0;background:#475569;border-radius:8px;max-height:150px;overflow:auto;z-index:10}
  .autocomplete-item{padding:6px;cursor:pointer}
  .autocomplete-item:hover{background:#6366f1}
</style>
</head>
<body>
  <div class="app">
    <h1>üí™ Workout Planner</h1>
    <div class="input-row">
      <select id="daySelect"></select>
      <div style="flex:1;position:relative">
        <input id="exerciseInput" placeholder="Ejercicio" oninput="showSuggestions()">
        <div id="autocomplete" class="autocomplete-list"></div>
      </div>
      <input id="sets" type="number" placeholder="Sets" style="width:66px">
      <input id="reps" type="number" placeholder="Reps" style="width:66px">
      <input id="weight" type="number" placeholder="Kg" style="width:66px">
      <button class="add-btn" id="addBtn">Add</button>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:12px">
      <button onclick="exportJSON()" style="background:#14b8a6;color:#fff;padding:8px;border-radius:8px">Export JSON</button>
      <button onclick="document.getElementById('fileInput').click()" style="background:#f59e0b;color:#fff;padding:8px;border-radius:8px">Import JSON</button>
      <input id="fileInput" type="file" accept="application/json" style="display:none" onchange="importJSON(event)">
    </div>

    <div id="week" class="week"></div>
  </div>

<script>
/* ---- IndexedDB wrapper ---- */
const DB_NAME = 'WorkoutPlannerDB';
const DB_VERSION = 1;
let _db = null;
async function openDB(){
  if(_db) return _db;
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('routines')) db.createObjectStore('routines', { keyPath:'name' });
      if(!db.objectStoreNames.contains('exercises')) db.createObjectStore('exercises', { keyPath:'name' });
    };
    req.onsuccess = e => { _db = e.target.result; res(_db); };
    req.onerror = e => rej(e.target.error);
  });
}
async function idbGet(storeName, key){
  const db = await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(storeName, 'readonly');
    const req = tx.objectStore(storeName).get(key);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}
async function idbGetAll(storeName){
  const db = await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(storeName, 'readonly');
    const req = tx.objectStore(storeName).getAll();
    req.onsuccess = () => res(req.result || []);
    req.onerror = () => rej(req.error);
  });
}
async function idbPut(storeName, value){
  const db = await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(storeName, 'readwrite');
    const req = tx.objectStore(storeName).put(value);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

/* ---- App state ---- */
const activeRoutine = localStorage.getItem('activeRoutine') || 'Default';
const daysOfWeek = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let routine = {};           // { dayName: [exercises...] }
let allExercises = [];      // list of exercise names

/* ---- Init ---- */
document.getElementById('addBtn').addEventListener('click', onAddClick);
async function init(){
  // fill day select
  const daySelect = document.getElementById('daySelect');
  daySelect.innerHTML = '';
  daysOfWeek.forEach(d => {
    const o = document.createElement('option');
    o.value = d; o.textContent = d;
    daySelect.appendChild(o);
  });

  await openDB();
  await ensureRoutineExistsAndLoad();
  await loadExercises();
  renderWeek();
}
async function ensureRoutineExistsAndLoad(){
  // always create an in-memory structure first so UI is immediate
  const stored = await idbGet('routines', activeRoutine);
  if(stored && stored.days){
    routine = stored.days;
  } else {
    // create 7 days in memory
    routine = {};
    daysOfWeek.forEach(d => routine[d] = []);
    // but also write to idb (don't wait blocking UI)
    try { await idbPut('routines', { name: activeRoutine, days: routine }); } catch(e){ console.warn('write initial routine failed', e); }
  }
}
/* load known exercises */
async function loadExercises(){
  const list = await idbGetAll('exercises');
  allExercises = list.map(x=>x.name);
}

/* ---- Autocomplete ---- */
function showSuggestions(){
  const q = document.getElementById('exerciseInput').value.trim().toLowerCase();
  const box = document.getElementById('autocomplete');
  box.innerHTML = '';
  if(!q) return;
  allExercises.filter(n => n.toLowerCase().includes(q)).slice(0,50).forEach(n=>{
    const div = document.createElement('div');
    div.className = 'autocomplete-item';
    div.textContent = n;
    div.onclick = ()=>{ document.getElementById('exerciseInput').value = n; box.innerHTML=''; };
    box.appendChild(div);
  });
}

/* ---- Add exercise (robust) ---- */
let adding = false;
async function onAddClick(e){
  if(adding) return;         // prevent double-click flood
  adding = true;
  try {
    await addExercise();
  } finally {
    adding = false;
  }
}
async function addExercise(){
  const day = document.getElementById('daySelect').value;
  const name = document.getElementById('exerciseInput').value.trim();
  const sets = parseInt(document.getElementById('sets').value) || 0;
  const reps = parseInt(document.getElementById('reps').value) || 0;
  const weight = parseFloat(document.getElementById('weight').value) || 0;
  if(!name || sets<=0 || reps<=0) { alert('Completa nombre, sets y reps'); return; }

  // ensure day exists in memory (guarantee)
  if(!routine[day]) routine[day] = [];

  // push to memory
  routine[day].push({ name, sets, reps, weight });

  // persist: update routine record then exercises store
  try{
    await idbPut('routines', { name: activeRoutine, days: routine });
    // add exercise name to exercises store (idempotent)
    if(!allExercises.includes(name)){
      await idbPut('exercises', { name });
      allExercises.push(name);
    }
  } catch(err){
    console.warn('DB put failed', err);
  }

  renderWeek();

  // clear inputs
  document.getElementById('exerciseInput').value='';
  document.getElementById('sets').value='';
  document.getElementById('reps').value='';
  document.getElementById('weight').value='';
  document.getElementById('autocomplete').innerHTML='';
}

/* ---- Edit / Delete ---- */
async function editExercise(day, idx){
  const ex = routine[day][idx];
  const newName = prompt('Ejercicio:', ex.name); if(!newName) return;
  const newSets = parseInt(prompt('Sets:', ex.sets)); if(!newSets) return;
  const newReps = parseInt(prompt('Reps:', ex.reps)); if(!newReps) return;
  const newWeight = parseFloat(prompt('Peso:', ex.weight)) || 0;
  routine[day][idx] = { name: newName, sets:newSets, reps:newReps, weight:newWeight };
  try{ await idbPut('routines', { name: activeRoutine, days: routine }); } catch(e){ console.warn(e); }
  // add to exercises store if new
  if(!allExercises.includes(newName)){
    try{ await idbPut('exercises', { name: newName }); allExercises.push(newName); } catch(e){ console.warn(e); }
  }
  renderWeek();
}
async function deleteExercise(day, idx){
  routine[day].splice(idx, 1);
  try{ await idbPut('routines', { name: activeRoutine, days: routine }); } catch(e){ console.warn(e); }
  renderWeek();
}

/* ---- Render ---- */
function renderWeek(){
  const week = document.getElementById('week');
  week.innerHTML = '';
  daysOfWeek.forEach(day=>{
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';
    dayDiv.innerHTML = `<h3>${day}</h3>`;
    const list = (routine[day] && routine[day].length) ? routine[day] : [];
    list.forEach((ex, i) => {
      const exDiv = document.createElement('div');
      exDiv.className = 'exercise';
      exDiv.innerHTML = `
        <span><b>${ex.name}</b></span>
        <span>${ex.sets} x ${ex.reps} @ ${ex.weight}kg</span>
        <div class="actions">
          <button onclick="editExercise('${day}',${i})">‚úèÔ∏è</button>
          <button onclick="deleteExercise('${day}',${i})">üóëÔ∏è</button>
        </div>
      `;
      dayDiv.appendChild(exDiv);
    });
    week.appendChild(dayDiv);
  });
}

/* ---- Export / Import ---- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(routine, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${activeRoutine}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importJSON(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    try{
      const data = JSON.parse(ev.target.result);
      // simple validation: expect object with day keys
      const isValid = daysOfWeek.every(d => data.hasOwnProperty(d));
      if(!isValid) return alert('Formato inv√°lido: el JSON debe contener los 7 d√≠as como claves');
      routine = data;
      await idbPut('routines', { name: activeRoutine, days: routine });
      renderWeek();
    }catch(err){ alert('Archivo inv√°lido'); }
  };
  reader.readAsText(file);
}

/* ---- Service Worker register (scope to folder) ---- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js', { scope: './' })
    .then(()=> console.log('SW registered (planner)'))
    .catch(e=> console.warn('SW register failed', e));
}

/* ---- start ---- */
init();
</script>
</body>
</html>
