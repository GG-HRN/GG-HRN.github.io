<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workout Planner</title>
<style>
body { margin:0; font-family:system-ui,sans-serif; background:#0f1724; color:#f1f5f9; display:flex; justify-content:center; padding:20px; }
.app { width:100%; max-width:900px; background:#1e293b; padding:20px; border-radius:12px; }
h1 { text-align:center; margin-bottom:15px; }
.input-row { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px; position:relative; }
input, select, button { padding:8px; border-radius:8px; border:none; font-size:14px; }
button { cursor:pointer; font-weight:600; }
button.add-btn { background:#6366f1; color:#fff; }
button.export-btn { background:#14b8a6; color:#fff; }
button.import-btn { background:#f59e0b; color:#fff; }
.week { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:12px; }
.day { background:#334155; padding:12px; border-radius:8px; }
.day h3 { margin:0 0 8px; font-size:16px; border-bottom:1px solid #475569; padding-bottom:4px; }
.exercise { background:#475569; margin-bottom:6px; padding:6px; border-radius:6px; font-size:14px; }
.exercise span { display:block; }
.actions button { background:transparent; color:#f1f5f9; font-size:12px; margin-top:4px; margin-right:4px; cursor:pointer; }
.autocomplete-list { position:absolute; top:40px; left:0; right:0; background:#475569; border-radius:8px; max-height:150px; overflow:auto; z-index:10; }
.autocomplete-item { padding:6px; cursor:pointer; }
.autocomplete-item:hover { background:#6366f1; }
</style>
<link rel="manifest" href="manifest.json">
</head>
<body>
<div class="app">
  <h1>üí™ Workout Planner</h1>

  <div class="input-row">
    <select id="daySelect"></select>
    <div style="flex:1; position:relative;">
      <input type="text" id="exerciseInput" placeholder="Ejercicio" oninput="showSuggestions()">
      <div id="autocomplete" class="autocomplete-list"></div>
    </div>
    <input type="number" id="sets" placeholder="Sets" style="width:60px">
    <input type="number" id="reps" placeholder="Reps" style="width:60px">
    <input type="number" id="weight" placeholder="Kg" style="width:60px">
    <button class="add-btn" onclick="addExercise()">Agregar</button>
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
    <button class="export-btn" onclick="exportJSON()">Exportar JSON</button>
    <button class="import-btn" onclick="document.getElementById('fileInput').click()">Importar JSON</button>
    <input type="file" id="fileInput" accept="application/json" style="display:none" onchange="importJSON(event)">
  </div>

  <div class="week" id="week"></div>
</div>

<script>
const activeRoutine = localStorage.getItem("activeRoutine") || "Default";
const daysOfWeek = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let db, routine = {}, allExercises = [];

const request = indexedDB.open("WorkoutPlannerDB",1);
request.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains("routines")) db.createObjectStore("routines",{keyPath:"name"});
  if(!db.objectStoreNames.contains("exercises")) db.createObjectStore("exercises",{keyPath:"name"});
};
request.onsuccess = e => { db = e.target.result; init(); };
function getStore(store,mode="readonly"){ return db.transaction(store,mode).objectStore(store); }

/* Cargar rutina activa */
function loadRoutine(){
  return new Promise(resolve=>{
    const tx = getStore("routines");
    const req = tx.get(activeRoutine);

    req.onsuccess = ()=>{
      if(req.result && req.result.days){
        routine = req.result.days;
        resolve();
      } else {
        // inicializar 7 d√≠as y guardar
        routine = {};
        daysOfWeek.forEach(d=> routine[d]=[]);
        const tx2 = getStore("routines","readwrite");
        const putReq = tx2.put({name:activeRoutine,days:routine});
        putReq.onsuccess = ()=> resolve();
        putReq.onerror = ()=> resolve();
      }
    };
    req.onerror = ()=> resolve();
  });
}

/* Guardar rutina activa */
function saveRoutine(){
  const tx = getStore("routines","readwrite");
  tx.put({name:activeRoutine,days:routine});
}

/* Cargar ejercicios conocidos */
function loadExercises(){
  return new Promise(resolve=>{
    const tx = getStore("exercises");
    const req = tx.getAll();
    req.onsuccess = ()=>{ allExercises = req.result.map(e=>e.name); resolve(); };
  });
}

/* Agregar ejercicio a la lista global */
function addExerciseToDB(name){
  if(!allExercises.includes(name)){
    allExercises.push(name);
    const tx = getStore("exercises","readwrite");
    tx.put({name});
  }
}

/* UI */
function init(){
  const daySelect = document.getElementById("daySelect");
  daysOfWeek.forEach(d=> daySelect.innerHTML += `<option value="${d}">${d}</option>`);
  Promise.all([loadRoutine(), loadExercises()]).then(renderWeek);
}

/* Autocomplete */
function showSuggestions(){
  const query = document.getElementById("exerciseInput").value.toLowerCase();
  const box = document.getElementById("autocomplete");
  box.innerHTML="";
  if(!query) return;
  const matches = allExercises.filter(e=>e.toLowerCase().includes(query));
  matches.forEach(m=>{
    const div = document.createElement("div");
    div.className="autocomplete-item";
    div.textContent=m;
    div.onclick=()=>{ document.getElementById("exerciseInput").value=m; box.innerHTML=""; };
    box.appendChild(div);
  });
}

/* Agregar ejercicio */
function addExercise(){
  const day = document.getElementById("daySelect").value;
  const name = document.getElementById("exerciseInput").value.trim();
  const sets = parseInt(document.getElementById("sets").value) || 0;
  const reps = parseInt(document.getElementById("reps").value) || 0;
  const weight = parseFloat(document.getElementById("weight").value) || 0;
  if(!name || sets<=0 || reps<=0) return alert("Completa nombre, sets y reps");

  routine[day].push({name,sets,reps,weight});
  addExerciseToDB(name);
  saveRoutine();
  renderWeek();

  document.getElementById("exerciseInput").value="";
  document.getElementById("sets").value="";
  document.getElementById("reps").value="";
  document.getElementById("weight").value="";
  document.getElementById("autocomplete").innerHTML="";
}

/* Editar */
function editExercise(day,i){
  const ex = routine[day][i];
  const newName = prompt("Ejercicio:", ex.name); if(!newName) return;
  const newSets = parseInt(prompt("Sets:", ex.sets)); if(!newSets) return;
  const newReps = parseInt(prompt("Reps:", ex.reps)); if(!newReps) return;
  const newWeight = parseFloat(prompt("Peso:", ex.weight)) || 0;
  routine[day][i] = {name:newName,sets:newSets,reps:newReps,weight:newWeight};
  addExerciseToDB(newName);
  saveRoutine();
  renderWeek();
}

/* Borrar */
function deleteExercise(day,i){
  routine[day].splice(i,1);
  saveRoutine();
  renderWeek();
}

/* Render */
function renderWeek(){
  const weekDiv = document.getElementById("week");
  weekDiv.innerHTML="";
  daysOfWeek.forEach(day=>{
    const dayDiv = document.createElement("div");
    dayDiv.className="day";
    dayDiv.innerHTML=`<h3>${day}</h3>`;
    routine[day].forEach((ex,i)=>{
      const exDiv = document.createElement("div");
      exDiv.className="exercise";
      exDiv.innerHTML=`
        <span><b>${ex.name}</b></span>
        <span>${ex.sets} x ${ex.reps} @ ${ex.weight}kg</span>
        <div class="actions">
          <button onclick="editExercise('${day}',${i})">‚úèÔ∏è</button>
          <button onclick="deleteExercise('${day}',${i})">üóëÔ∏è</button>
        </div>
      `;
      dayDiv.appendChild(exDiv);
    });
    weekDiv.appendChild(dayDiv);
  });
}

/* Exportar/Importar JSON por rutina */
function exportJSON(){
  const data = JSON.stringify(routine,null,2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${activeRoutine}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function importJSON(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      routine = data;
      saveRoutine();
      renderWeek();
    }catch(err){ alert("Archivo inv√°lido"); }
  };
  reader.readAsText(file);
}

/* Service Worker */
if("serviceWorker" in navigator){ navigator.serviceWorker.register("sw.js"); }
</script>
</body>
</html>
