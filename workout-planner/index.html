<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Workout Planner</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Workout Planner">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<style>
body{margin:0;font-family:system-ui,Arial;background:#0f1724;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px}
h1{text-align:center;margin-bottom:20px}
#cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;width:100%;max-width:800px;margin-bottom:20px}
.card{position:relative;display:flex;flex-direction:column;align-items:center;gap:8px;background:#1e293b;padding:15px;border-radius:12px;cursor:pointer;transition:0.2s}
.card:hover{background:#374151}
.card h2{margin:0;font-size:16px;word-break:break-word}
.progress-text{font-size:12px;color:#cbd5e1}
.badge{position:absolute;top:8px;right:8px;background:#ef4444;color:#fff;padding:2px 6px;border-radius:50%;font-size:12px;font-weight:700}
.new-row{display:flex;width:100%;max-width:400px;gap:8px;margin-bottom:20px}
.new-row input{flex:1;padding:10px;border-radius:8px;border:0;font-size:16px}
.new-row button{padding:10px;border-radius:8px;border:0;background:#6366f1;color:#fff;font-weight:700;font-size:16px}
</style>
</head>
<body>
<h1>üèãÔ∏è Workout Routines</h1>

<div id="cards"></div>

<div class="new-row">
  <input id="newRoutineName" placeholder="New routine name">
  <button id="createBtn">Create</button>
</div>

<script>
/* --- IndexedDB helper --- */
const DB_NAME = 'WorkoutDB';
const DB_VERSION = 1;
let dbPromise;

function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('routines')) db.createObjectStore('routines',{keyPath:'name'});
    };
    req.onsuccess=e=>resolve(e.target.result);
    req.onerror=e=>reject(e.target.error);
  });
  return dbPromise;
}

async function idbGetAll(store){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).getAll();
    req.onsuccess=()=>res(req.result || []);
    req.onerror=()=>rej(req.error);
  });
}

async function idbGet(store,key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

async function idbPut(store,value){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    const req=tx.objectStore(store).put(value);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

/* --- UI logic --- */
const cardsDiv = document.getElementById('cards');
const input = document.getElementById('newRoutineName');
document.getElementById('createBtn').addEventListener('click', createRoutine);

async function loadCards(){
  cardsDiv.innerHTML='';
  const routines = await idbGetAll('routines');
  routines.forEach(r=>{
    const total = Object.values(r.days||{}).reduce((sum,day)=>sum+day.length,0);
    const completed = Object.values(r.days||{}).reduce((sum,day)=>sum+day.filter(e=>e.done).length,0);
    const perc = total? completed/total : 0;

    const div = document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <h2>${r.name}</h2>
      <canvas width="50" height="50"></canvas>
      <div class="progress-text">${completed}/${total} exercises</div>
      <div class="badge">${total-completed}</div>
    `;
    drawCircle(div.querySelector('canvas'), perc);
    div.onclick=()=>openRoutine(r.name);
    cardsDiv.appendChild(div);
  });
}

function drawCircle(canvas, progress){
  const ctx = canvas.getContext('2d');
  const center = canvas.width/2;
  const radius = center - 4;
  const startAngle = -0.5 * Math.PI;
  const endAngle = startAngle + progress*2*Math.PI;

  let color = '#ef4444';
  if(progress>=0.5 && progress<0.8) color='#fbbf24';
  else if(progress>=0.8) color='#6366f1';

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.beginPath();
  ctx.arc(center,center,radius,0,2*Math.PI);
  ctx.strokeStyle='#475569';
  ctx.lineWidth=6;
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(center,center,radius,startAngle,endAngle);
  ctx.strokeStyle=color;
  ctx.lineWidth=6;
  ctx.stroke();
}

async function createRoutine(){
  const name = input.value.trim();
  if(!name) return alert('Enter a routine name');
  const existing = await idbGet('routines',name);
  if(existing){ alert('Routine already exists'); return; }
  await idbPut('routines',{ name, days:{} });
  input.value='';
  loadCards();
}

function openRoutine(name){
  localStorage.setItem('activeRoutine',name);
  window.location.href='planner.html';
}

/* --- Service Worker --- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js',{scope:'./'})
    .then(()=>console.log('SW registered'))
    .catch(e=>console.warn('SW failed',e));
}

/* --- Init --- */
loadCards();
</script>
</body>
</html>
